<!doctype html>
<html lang="zh-CN" data-theme="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Token Panel</title>

    <!-- 1. DaisyUI CSS -->
    <link href="https://cdn.jsdelivr.net/npm/daisyui@5" rel="stylesheet" type="text/css" />

    <!-- 2. Tailwind -->
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>

    <!-- 3. Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.15.8/dist/cdn.min.js"></script>

    <!-- 4. Day.js -->
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.19/dayjs.min.js"></script>
  </head>
  <body class="min-h-screen bg-base-200">
    <div x-data="tokenPanel">

      <!-- Navbar -->
      <div class="navbar bg-base-100 shadow-sm px-6 sticky top-0 z-10">
        <div class="flex-1 gap-3">
          <span class="text-xl font-bold">Token Panel</span>
          <span x-show="lastUpdatedText" x-text="lastUpdatedText"
                class="text-xs text-base-content/40"></span>
        </div>
        <div class="flex-none">
          <button class="btn btn-primary btn-sm" @click="openNewGroup()">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4" aria-hidden="true"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
            新建看板
          </button>
        </div>
      </div>

      <!-- Boards -->
      <div class="flex gap-4 p-6 overflow-x-auto items-start min-h-[calc(100vh-64px)]">

        <!-- Loading -->
        <template x-if="isLoading && groups.length === 0">
          <div class="flex items-center justify-center w-full h-64">
            <span class="loading loading-spinner loading-lg"></span>
          </div>
        </template>

        <!-- Empty state -->
        <template x-if="!isLoading && groups.length === 0">
          <div class="flex flex-col items-center justify-center w-full h-64 gap-3 text-base-content/40">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="w-12 h-12" aria-hidden="true"><rect width="7" height="7" x="3" y="3" rx="1"></rect><rect width="7" height="7" x="14" y="3" rx="1"></rect><rect width="7" height="7" x="14" y="14" rx="1"></rect><rect width="7" height="7" x="3" y="14" rx="1"></rect></svg>
            <p>还没有看板，点击右上角新建看板开始</p>
          </div>
        </template>

        <!-- Board columns -->
        <template x-for="group in groups" :key="group.id">
          <div class="card bg-base-100 shadow w-72 flex-shrink-0">
            <div class="card-body p-4 gap-3">

              <!-- Board header -->
              <div class="flex items-center justify-between">
                <h2 class="font-bold text-base truncate" x-text="group.name"></h2>
                <div class="flex gap-1 flex-shrink-0">
                  <button class="btn btn-ghost btn-xs" @click="openEditGroup(group)"
                          title="重命名">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-3.5 h-3.5" aria-hidden="true"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"></path><path d="m15 5 4 4"></path></svg>
                  </button>
                  <button class="btn btn-ghost btn-xs text-error" @click="deleteGroup(group.id)"
                          title="删除看板">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-3.5 h-3.5" aria-hidden="true"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                  </button>
                </div>
              </div>

              <!-- Token cards -->
              <div class="flex flex-col gap-2">
                <template x-for="coin in group.coins" :key="coin">
                  <div class="bg-base-200 rounded-xl p-3 relative group/card">
                    <button
                      class="btn btn-ghost btn-xs absolute top-1 right-1 opacity-0 group-hover/card:opacity-100 transition-opacity"
                      @click="removeCoin(group.id, coin)" title="移除">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-3 h-3" aria-hidden="true"><path d="M18 6 6 18"></path><path d="m6 6 12 12"></path></svg>
                    </button>

                    <div class="font-bold text-sm mb-1" x-text="coin"></div>

                    <template x-if="prices[coin]">
                      <div>
                        <div class="text-lg font-mono font-semibold"
                             x-text="formatPrice(prices[coin].price)"></div>
                        <div class="flex items-center justify-between text-xs mt-1">
                          <span :class="deltaClass(prices[coin].delta_24h)"
                                x-text="formatDelta(prices[coin].delta_24h)"></span>
                          <span class="text-base-content/50"
                                x-text="formatMarketCap(prices[coin].market_cap)"></span>
                        </div>
                      </div>
                    </template>
                    <template x-if="!prices[coin]">
                      <div class="text-xs text-base-content/30">暂无数据</div>
                    </template>
                  </div>
                </template>
              </div>

              <!-- Add coin -->
              <button class="btn btn-ghost btn-sm w-full text-base-content/50"
                      @click="openAddCoin(group.id)">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4" aria-hidden="true"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                添加代币
              </button>
            </div>
          </div>
        </template>
      </div>

      <!-- Group modal (new / edit) -->
      <dialog x-ref="groupModal" class="modal">
        <div class="modal-box">
          <h3 class="text-lg font-bold mb-4"
              x-text="groupModal.isEdit ? '修改看板名称' : '新建看板'"></h3>
          <input type="text" class="input input-bordered w-full"
                 placeholder="看板名称"
                 x-model="groupModal.name"
                 @keydown.enter="confirmGroup()" />
          <div class="modal-action">
            <button class="btn btn-ghost"
                    @click="$refs.groupModal.close()">取消</button>
            <button class="btn btn-primary" @click="confirmGroup()">确认</button>
          </div>
        </div>
        <form method="dialog" class="modal-backdrop">
          <button>close</button>
        </form>
      </dialog>

      <!-- Add coin modal -->
      <dialog x-ref="coinModal" class="modal">
        <div class="modal-box">
          <h3 class="text-lg font-bold mb-4">添加代币</h3>
          <input type="text" class="input input-bordered w-full"
                 placeholder="代币符号，如 BTC、ETH、SOL"
                 x-model="coinModal.symbol"
                 @keydown.enter="confirmCoin()" />
          <div class="modal-action">
            <button class="btn btn-ghost"
                    @click="$refs.coinModal.close()">取消</button>
            <button class="btn btn-primary" @click="confirmCoin()">确认</button>
          </div>
        </div>
        <form method="dialog" class="modal-backdrop">
          <button>close</button>
        </form>
      </dialog>

      <!-- Toast -->
      <div class="toast toast-top toast-center z-50">
        <template x-for="t in $store.toast.items" :key="t.id">
          <div x-transition :class="'alert alert-' + t.type">
            <span x-text="t.message"></span>
          </div>
        </template>
      </div>
    </div>

    <script>
      // --- API helpers (native fetch) ---
      const groupApi = {
        getAll() {
          return fetch("/api/groups").then((r) => {
            if (!r.ok) throw new Error(`HTTP ${r.status}`);
            return r.json();
          });
        },
        update(groups) {
          return fetch("/api/groups", {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(groups),
          }).then((r) => {
            if (!r.ok) throw new Error(`HTTP ${r.status}`);
            return r.json();
          });
        },
      };

      const priceApi = {
        getAll() {
          return fetch("/api/prices").then((r) => {
            if (!r.ok) throw new Error(`HTTP ${r.status}`);
            return r.json();
          });
        },
      };

      const TOAST_MAX = 5;
      const TOAST_DURATION_MS = 3000;
      const toast = (msg, type) => Alpine.store("toast")?.show(msg, type);

      document.addEventListener("alpine:init", () => {
        Alpine.store("toast", {
          items: [],
          show(msg, type = "success") {
            const id = Date.now();
            this.items.push({ id, message: msg, type });
            if (this.items.length > TOAST_MAX) this.items.shift();
            setTimeout(() => {
              this.items = this.items.filter((t) => t.id !== id);
            }, TOAST_DURATION_MS);
          },
        });

        Alpine.data("tokenPanel", () => ({
          groups: [],
          prices: {},
          lastUpdated: null,
          isLoading: false,

          groupModal: { isEdit: false, id: null, name: "" },
          coinModal: { groupId: null, symbol: "" },

          async init() {
            await this.loadData();
            setInterval(() => this.refreshPrices(), 5 * 60 * 1000);
          },

          async loadData() {
            this.isLoading = true;
            try {
              const [groups, priceResult] = await Promise.all([
                groupApi.getAll(),
                priceApi.getAll(),
              ]);
              this.groups = groups;
              this.prices = priceResult.data;
              this.lastUpdated = priceResult.updatedAt
                ? new Date(priceResult.updatedAt)
                : null;
            } catch (e) {
              toast("加载失败", "error");
            } finally {
              this.isLoading = false;
            }
          },

          async refreshPrices() {
            try {
              const priceResult = await priceApi.getAll();
              this.prices = priceResult.data;
              this.lastUpdated = priceResult.updatedAt
                ? new Date(priceResult.updatedAt)
                : null;
            } catch (e) {
              toast("价格更新失败", "error");
            }
          },

          async saveGroups() {
            try {
              await groupApi.update(this.groups);
            } catch (e) {
              toast("保存失败，请重试", "error");
              await this.loadData(); // re-sync with server
              throw e;
            }
          },

          // --- Group actions ---

          openNewGroup() {
            this.groupModal = { isEdit: false, id: null, name: "" };
            this.$refs.groupModal.showModal();
          },

          openEditGroup(group) {
            this.groupModal = { isEdit: true, id: group.id, name: group.name };
            this.$refs.groupModal.showModal();
          },

          async confirmGroup() {
            const name = this.groupModal.name.trim();
            if (!name) return;
            if (this.groupModal.isEdit) {
              const g = this.groups.find((g) => g.id === this.groupModal.id);
              if (g) g.name = name;
            } else {
              this.groups.push({
                id: crypto.randomUUID(),
                name,
                coins: [],
              });
            }
            this.$refs.groupModal.close();
            await this.saveGroups();
          },

          async deleteGroup(id) {
            if (!confirm("确认删除该看板？")) return;
            this.groups = this.groups.filter((g) => g.id !== id);
            await this.saveGroups();
          },

          // --- Coin actions ---

          openAddCoin(groupId) {
            this.coinModal = { groupId, symbol: "" };
            this.$refs.coinModal.showModal();
          },

          async confirmCoin() {
            const symbol = this.coinModal.symbol.trim().toUpperCase();
            if (!symbol) return;
            const g = this.groups.find((g) => g.id === this.coinModal.groupId);
            if (g && !g.coins.includes(symbol)) {
              g.coins.push(symbol);
              this.$refs.coinModal.close();
              await this.saveGroups();
              await this.refreshPrices();
            } else {
              this.$refs.coinModal.close();
              if (g) toast("该代币已在看板中", "warning");
            }
          },

          async removeCoin(groupId, symbol) {
            const g = this.groups.find((g) => g.id === groupId);
            if (!g) return;
            g.coins = g.coins.filter((c) => c !== symbol);
            await this.saveGroups();
          },

          // --- Formatting ---

          formatPrice(price) {
            if (price >= 1) {
              return (
                "$" +
                price.toLocaleString("en-US", { maximumFractionDigits: 2 })
              );
            }
            return "$" + price.toPrecision(4);
          },

          formatDelta(delta) {
            const pct = (delta * 100).toFixed(2);
            return (delta >= 0 ? "+" : "") + pct + "%";
          },

          deltaClass(delta) {
            return delta >= 0 ? "text-success" : "text-error";
          },

          formatMarketCap(cap) {
            if (!cap) return "—";
            if (cap >= 1e12) return (cap / 1e12).toFixed(2) + "T";
            if (cap >= 1e9) return (cap / 1e9).toFixed(2) + "B";
            if (cap >= 1e6) return (cap / 1e6).toFixed(2) + "M";
            return cap.toLocaleString("en-US");
          },

          get lastUpdatedText() {
            if (!this.lastUpdated) return "";
            return (
              "更新于 " +
              dayjs(this.lastUpdated).format("HH:mm:ss")
            );
          },
        }));
      });
    </script>
  </body>
</html>
