<!doctype html>
<html lang="zh-CN" data-theme="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="description"
      content="Live BTC, ETH, SOL prices with 24H change and market overview."
    />
    <link rel="icon" href="/favicon.png" />
    <link
      href="https://cdn.jsdelivr.net/npm/daisyui@5"
      rel="stylesheet"
      type="text/css"
    />
    <title>TPP-Token Price Panel</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/alpinejs@3.15.8/dist/cdn.min.js"
    ></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.19/dayjs.min.js"></script>
    <style>
      @keyframes flash-up {
        0%,
        50% {
          color: var(--color-success);
        }
        100% {
          color: inherit;
        }
      }
      @keyframes flash-down {
        0%,
        50% {
          color: var(--color-error);
        }
        100% {
          color: inherit;
        }
      }
      .price-flash-up {
        animation: flash-up 2s ease-out forwards;
      }
      .price-flash-down {
        animation: flash-down 2s ease-out forwards;
      }
    </style>
  </head>
  <body class="min-h-screen bg-base-200">
    <div x-data="tokenPanel">
      <!-- Navbar -->
      <div class="navbar bg-base-100 shadow-sm px-6 sticky top-0 z-10">
        <div class="flex-1 gap-3">
          <span class="text-xl font-bold">Token Panel</span>
          <span
            x-show="lastUpdatedText"
            x-text="lastUpdatedText"
            class="text-xs text-base-content/40"
          ></span>
        </div>
        <div class="flex-none gap-2 flex items-center">
          <!-- API mode toggle -->
          <div
            class="tooltip tooltip-bottom"
            :data-tip="useDirectApi ? '直连 api.coingecko.com' : '后端代理'"
          >
            <button
              class="btn btn-xs"
              :class="useDirectApi ? 'btn-info btn-outline' : 'btn-ghost opacity-40'"
              @click="toggleApiMode()"
              aria-label="切换 API 模式"
            >
              <span x-text="useDirectApi ? 'Direct' : 'Proxy'"></span>
            </button>
          </div>
          <!-- Price error indicator -->
          <div x-show="priceError" class="tooltip tooltip-bottom" :data-tip="priceError">
            <button
              class="btn btn-sm btn-ghost text-warning"
              @click="refreshPrices()"
              aria-label="价格加载失败，点击重试"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                class="w-4 h-4"
                aria-hidden="true"
              >
                <path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"></path>
                <path d="M12 9v4"></path>
                <path d="M12 17h.01"></path>
              </svg>
            </button>
          </div>
          <button
            class="btn btn-sm"
            :class="isEditMode ? 'btn-success' : 'btn-ghost'"
            @click="toggleEditMode()"
          >
            <!-- 编辑图标 -->
            <svg
              x-show="!isEditMode"
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              class="w-4 h-4"
              aria-hidden="true"
            >
              <path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"></path>
              <path d="m15 5 4 4"></path>
            </svg>
            <!-- 完成图标 -->
            <svg
              x-show="isEditMode"
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              class="w-4 h-4"
              aria-hidden="true"
            >
              <path d="M20 6 9 17l-5-5"></path>
            </svg>
            <span x-text="isEditMode ? '完成' : '编辑'"></span>
          </button>
        </div>
      </div>

      <!-- Alert bar -->
      <div class="relative z-20">
        <div
          x-show="$store.alert.visible"
          x-transition:enter="transition ease-out duration-200"
          x-transition:enter-start="opacity-0 -translate-y-2"
          x-transition:enter-end="opacity-100 translate-y-0"
          x-transition:leave="transition ease-in duration-150"
          x-transition:leave-start="opacity-100 translate-y-0"
          x-transition:leave-end="opacity-0 -translate-y-2"
          class="absolute inset-x-0 pt-2"
          role="alert"
        >
          <div class="max-w-6xl mx-auto px-4 md:px-6">
            <div :class="'alert alert-' + $store.alert.type" class="shadow-md">
              <span x-text="$store.alert.message"></span>
              <button
                class="btn btn-ghost btn-sm btn-square ml-auto"
                @click="$store.alert.dismiss()"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  class="w-4 h-4"
                  aria-hidden="true"
                >
                  <path d="M18 6 6 18"></path>
                  <path d="m6 6 12 12"></path>
                </svg>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Boards -->
      <div
        class="flex flex-wrap gap-3 p-3 sm:gap-4 sm:p-6 items-start content-start min-h-[calc(100vh-64px)] max-w-screen-2xl mx-auto"
      >
        <!-- Loading -->
        <template x-if="isLoading && groups.length === 0">
          <div class="flex items-center justify-center w-full h-64">
            <span class="loading loading-spinner loading-lg"></span>
          </div>
        </template>

        <!-- Load error -->
        <template x-if="!isLoading && loadError">
          <div
            class="flex flex-col items-center justify-center w-full h-64 gap-2 text-base-content/60"
          >
            <span class="text-sm" x-text="loadError"></span>
            <button class="btn btn-sm" @click="loadData()">重试</button>
          </div>
        </template>

        <!-- Empty state -->
        <template x-if="!isLoading && !loadError && groups.length === 0">
          <div
            class="flex flex-col items-center justify-center w-full h-64 gap-3 text-base-content/40"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="1.5"
              stroke-linecap="round"
              stroke-linejoin="round"
              class="w-12 h-12"
              aria-hidden="true"
            >
              <rect width="7" height="7" x="3" y="3" rx="1"></rect>
              <rect width="7" height="7" x="14" y="3" rx="1"></rect>
              <rect width="7" height="7" x="14" y="14" rx="1"></rect>
              <rect width="7" height="7" x="3" y="14" rx="1"></rect>
            </svg>
            <p>还没有看板，点击右上角新建看板开始</p>
          </div>
        </template>

        <!-- Board columns -->
        <template x-for="group in groups" :key="group.id">
          <div class="card bg-base-100 shadow w-full sm:w-80 flex-shrink-0">
            <div class="card-body p-4 gap-3">
              <!-- Board header -->
              <div class="flex items-center justify-between">
                <h2
                  class="font-bold text-base truncate"
                  x-text="group.name"
                ></h2>
                <div class="flex gap-1 flex-shrink-0" x-show="isEditMode">
                  <button
                    class="btn btn-ghost btn-xs"
                    @click="openEditGroup(group)"
                    title="重命名"
                  >
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      class="w-3.5 h-3.5"
                      aria-hidden="true"
                    >
                      <path
                        d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"
                      ></path>
                      <path d="m15 5 4 4"></path>
                    </svg>
                  </button>
                  <button
                    class="btn btn-ghost btn-xs text-error"
                    @click="openDeleteGroup(group.id)"
                    title="删除看板"
                  >
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      class="w-3.5 h-3.5"
                      aria-hidden="true"
                    >
                      <path d="M3 6h18"></path>
                      <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
                      <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
                      <line x1="10" y1="11" x2="10" y2="17"></line>
                      <line x1="14" y1="11" x2="14" y2="17"></line>
                    </svg>
                  </button>
                </div>
              </div>

              <!-- Token cards -->
              <div class="flex flex-col">
                <!-- Column header -->
                <template x-if="group.coins.length > 0">
                  <div
                    class="grid grid-cols-[1.5rem_2rem_1fr_5rem_1rem] gap-x-2 items-end px-1 pb-1.5 mb-0.5 border-b border-base-300"
                  >
                    <span class="text-[10px] text-base-content/40 text-right"
                      >#</span
                    >
                    <span></span>
                    <div>
                      <div
                        class="text-[10px] text-base-content/50 leading-none"
                      >
                        名字
                      </div>
                      <div class="text-[9px] text-base-content/30 leading-snug">
                        ATH / DD%
                      </div>
                    </div>
                    <div class="text-right">
                      <div
                        class="text-[10px] text-base-content/50 leading-none"
                      >
                        价格
                      </div>
                      <div class="text-[9px] text-base-content/30 leading-snug">
                        24hr
                      </div>
                    </div>
                    <span></span>
                  </div>
                </template>

                <template x-for="coin in group.coins" :key="coin">
                  <div
                    class="grid grid-cols-[1.5rem_2rem_1fr_5rem_1rem] gap-x-2 items-center px-1 py-2.5 rounded-lg group/card hover:bg-base-200 transition-colors cursor-pointer"
                    @click="!isEditMode && window.open('https://www.coingecko.com/en/coins/' + coin + '?utm_source=token-panel&utm_medium=referral', '_blank')"
                  >
                    <!-- Rank -->
                    <span
                      class="text-[11px] text-base-content/35 text-right tabular-nums"
                      x-text="prices[coin]?.market_cap_rank ?? '—'"
                    ></span>

                    <!-- Logo -->
                    <div
                      class="w-8 h-8 rounded-full flex-shrink-0 flex items-center justify-center overflow-hidden"
                      style="background: var(--color-base-300)"
                    >
                      <template x-if="prices[coin]?.image">
                        <img
                          :src="prices[coin].image"
                          :alt="coin"
                          class="w-full h-full object-contain p-0.5"
                        />
                      </template>
                      <template x-if="!prices[coin]?.image">
                        <span
                          class="text-[9px] font-bold text-base-content/50"
                          x-text="(prices[coin]?.symbol?.toUpperCase() ?? coin).slice(0, 2)"
                        ></span>
                      </template>
                    </div>

                    <!-- Name + ATH + 24h High/Low -->
                    <div class="min-w-0">
                      <div
                        class="text-sm font-semibold leading-snug truncate"
                        x-text="prices[coin]?.name ?? coin"
                      ></div>
                      <div class="flex gap-1.5 items-center mt-0.5">
                        <span
                          class="text-xs font-mono text-base-content/45 leading-none tabular-nums"
                          x-text="prices[coin]?.ath ? formatPrice(prices[coin].ath) : '—'"
                        ></span>
                        <span
                          class="text-xs leading-none tabular-nums"
                          :class="athDdClass(prices[coin])"
                          x-text="prices[coin] ? formatAthDd(prices[coin]) : '—'"
                        ></span>
                      </div>
                      <div class="flex gap-1.5 items-center mt-0.5">
                        <span class="text-[10px] text-base-content/30 leading-none">H</span>
                        <span
                          class="text-[10px] font-mono text-base-content/40 leading-none tabular-nums"
                          x-text="prices[coin]?.high_24h ? formatPrice(prices[coin].high_24h) : '—'"
                        ></span>
                        <span class="text-[10px] text-base-content/30 leading-none">L</span>
                        <span
                          class="text-[10px] font-mono text-base-content/40 leading-none tabular-nums"
                          x-text="prices[coin]?.low_24h ? formatPrice(prices[coin].low_24h) : '—'"
                        ></span>
                      </div>
                    </div>

                    <!-- Price + 24hr -->
                    <div class="text-right min-w-0">
                      <div
                        class="text-sm font-mono font-semibold leading-snug tabular-nums"
                        :class="priceFlash[coin] === 'up' ? 'price-flash-up' : priceFlash[coin] === 'down' ? 'price-flash-down' : ''"
                        x-text="prices[coin] ? formatPrice(prices[coin].current_price) : '—'"
                      ></div>
                      <div
                        class="text-xs leading-none tabular-nums mt-0.5"
                        :class="prices[coin]?.price_change_percentage_24h != null ? deltaClass(prices[coin].price_change_percentage_24h) : 'text-base-content/30'"
                        x-text="prices[coin]?.price_change_percentage_24h != null ? formatDelta(prices[coin].price_change_percentage_24h) : '—'"
                      ></div>
                    </div>

                    <!-- Remove -->
                    <button
                      x-show="isEditMode"
                      class="btn btn-ghost btn-xs w-4 h-4 p-0 min-h-0"
                      @click="removeCoin(group.id, coin)"
                      title="移除"
                    >
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        class="w-3 h-3"
                        aria-hidden="true"
                      >
                        <path d="M18 6 6 18"></path>
                        <path d="m6 6 12 12"></path>
                      </svg>
                    </button>
                  </div>
                </template>
              </div>

              <!-- Add coin -->
              <button
                x-show="isEditMode"
                class="btn btn-ghost btn-sm w-full text-base-content/50"
                @click="openAddCoin(group.id)"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  class="w-4 h-4"
                  aria-hidden="true"
                >
                  <line x1="12" y1="5" x2="12" y2="19"></line>
                  <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                添加代币
              </button>
            </div>
          </div>
        </template>

        <!-- New group card (edit mode only) -->
        <template x-if="isEditMode">
          <button
            class="card bg-base-100 shadow w-full sm:w-80 flex-shrink-0 h-24 flex items-center justify-center gap-2 border-2 border-dashed border-base-300 hover:border-primary hover:text-primary text-base-content/40 transition-colors cursor-pointer"
            @click="openNewGroup()"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              class="w-5 h-5"
              aria-hidden="true"
            >
              <line x1="12" y1="5" x2="12" y2="19"></line>
              <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            <span class="text-sm">新建看板</span>
          </button>
        </template>
      </div>

      <!-- Group modal (new / edit) -->
      <dialog x-ref="groupModal" class="modal">
        <div class="modal-box">
          <h3
            class="text-lg font-bold mb-4"
            x-text="groupModal.isEdit ? '修改看板名称' : '新建看板'"
          ></h3>
          <input
            type="text"
            class="input input-bordered w-full"
            placeholder="看板名称"
            x-model="groupModal.name"
            @keydown.enter="confirmGroup()"
          />
          <div class="modal-action">
            <button
              class="btn btn-ghost"
              :disabled="isSaving"
              @click="$refs.groupModal.close()"
            >
              取消
            </button>
            <button
              class="btn btn-primary"
              :disabled="isSaving"
              @click="confirmGroup()"
            >
              <span
                x-show="isSaving"
                class="loading loading-spinner loading-sm"
              ></span>
              确认
            </button>
          </div>
        </div>
        <form method="dialog" class="modal-backdrop">
          <button>close</button>
        </form>
      </dialog>

      <!-- Add coin modal -->
      <dialog x-ref="coinModal" class="modal">
        <div class="modal-box">
          <h3 class="text-lg font-bold mb-4">添加代币</h3>
          <div class="flex gap-2">
            <input
              type="text"
              class="input input-bordered flex-1"
              placeholder="搜索代币名称或符号"
              x-model="coinModal.query"
              @keydown.enter="searchCoins()"
            />
            <button
              class="btn btn-primary"
              :disabled="coinModal.isSearching"
              @click="searchCoins()"
            >
              <span
                x-show="coinModal.isSearching"
                class="loading loading-spinner loading-sm"
              ></span>
              <span x-show="!coinModal.isSearching">搜索</span>
            </button>
          </div>

          <!-- Search error -->
          <template x-if="coinModal.searchError">
            <p
              class="text-sm text-base-content/50 mt-2"
              x-text="coinModal.searchError"
            ></p>
          </template>

          <!-- Results -->
          <div class="mt-3 flex flex-col gap-0.5 max-h-64 overflow-y-auto">
            <template x-for="result in coinModal.results" :key="result.id">
              <button
                class="flex items-center gap-3 px-2 py-2 rounded-lg hover:bg-base-200 transition-colors text-left w-full"
                :disabled="isSaving"
                @click="selectCoin(result.id)"
              >
                <img
                  :src="result.thumb"
                  :alt="result.name"
                  class="w-7 h-7 rounded-full flex-shrink-0"
                />
                <span
                  class="text-sm font-semibold truncate"
                  x-text="result.name"
                ></span>
                <span
                  class="text-xs text-base-content/40 flex-shrink-0"
                  x-text="result.symbol"
                ></span>
                <span
                  class="text-xs text-base-content/30 ml-auto flex-shrink-0"
                  x-text="result.market_cap_rank ? '#' + result.market_cap_rank : ''"
                ></span>
                <span
                  x-show="isSaving"
                  class="loading loading-spinner loading-xs flex-shrink-0"
                ></span>
              </button>
            </template>
          </div>

          <div class="modal-action">
            <button class="btn btn-ghost" @click="$refs.coinModal.close()">
              取消
            </button>
          </div>
        </div>
        <form method="dialog" class="modal-backdrop">
          <button>close</button>
        </form>
      </dialog>

      <!-- Delete confirm modal -->
      <dialog x-ref="confirmModal" class="modal">
        <div class="modal-box">
          <h3 class="text-lg font-bold mb-2">删除看板</h3>
          <p class="text-base-content/70 mb-4">
            确认删除该看板？此操作不可撤销。
          </p>
          <div class="modal-action">
            <button class="btn btn-ghost" @click="$refs.confirmModal.close()">
              取消
            </button>
            <button
              class="btn btn-error"
              :disabled="isSaving"
              @click="confirmDelete()"
            >
              <span
                x-show="isSaving"
                class="loading loading-spinner loading-sm"
              ></span>
              删除
            </button>
          </div>
        </div>
        <form method="dialog" class="modal-backdrop">
          <button>close</button>
        </form>
      </dialog>

      <!-- Footer -->
      <footer class="border-t border-base-300 bg-base-100">
        <div
          class="max-w-screen-2xl mx-auto px-3 sm:px-6 py-5 text-sm opacity-70 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2"
        >
          <p>© <span x-text="new Date().getFullYear()"></span> Token Panel</p>
          <p>
            Powered by
            <a
              href="https://www.coingecko.com/en/api/?utm_source=token-panel&utm_medium=referral"
              target="_blank"
              rel="noopener noreferrer"
              class="underline underline-offset-2 hover:text-primary transition-colors"
              >CoinGecko API</a
            >
          </p>
        </div>
      </footer>
    </div>

    <script>
      // --- API helpers (native fetch) ---
      const API_BASE_URL = "https://tpp.testbug.cc";
      const groupsUrl = `${API_BASE_URL}/api/groups`;
      let useDirectApi = localStorage.getItem("cgDirectApi") === "true";
      const getCgBase = () =>
        useDirectApi
          ? "https://api.coingecko.com/api/v3"
          : `${API_BASE_URL}/api/v3`;

      const groupApi = {
        getAll() {
          return fetch(groupsUrl).then((r) => {
            if (!r.ok) throw new Error(`HTTP ${r.status}`);
            return r.json();
          });
        },
        update(groups) {
          return fetch(groupsUrl, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(groups),
          }).then((r) => {
            if (!r.ok) throw new Error(`HTTP ${r.status}`);
          });
        },
      };

      // --- CoinGecko API ---
      const coingeckoApi = {
        search(query) {
          return fetch(`${getCgBase()}/search?query=${encodeURIComponent(query)}`)
            .then((r) => {
              if (!r.ok) throw new Error(`HTTP ${r.status}`);
              return r.json();
            })
            .then((d) => d.coins.slice(0, 8));
        },
        getMarkets(ids) {
          if (!ids.length) return Promise.resolve([]);
          return fetch(
            `${getCgBase()}/coins/markets?vs_currency=usd&ids=${ids.join(",")}&price_change_percentage=24h`,
          ).then((r) => {
            if (!r.ok) throw new Error(`HTTP ${r.status}`);
            return r.json();
          });
        },
      };

      let _alertTimer = null;
      const toast = (msg, type) => Alpine.store("alert")?.show(msg, type);

      document.addEventListener("alpine:init", () => {
        Alpine.store("alert", {
          message: "",
          type: "success",
          visible: false,
          show(msg, type = "success") {
            clearTimeout(_alertTimer);
            this.message = msg;
            this.type = type;
            this.visible = true;
            _alertTimer = setTimeout(() => {
              this.visible = false;
            }, 3000);
          },
          dismiss() {
            clearTimeout(_alertTimer);
            this.visible = false;
          },
        });

        Alpine.data("tokenPanel", () => ({
          groups: [],
          prices: {},
          priceFlash: {},
          lastUpdated: null,
          isEditMode: false,
          useDirectApi: localStorage.getItem("cgDirectApi") === "true",
          isLoading: false,
          loadError: "",
          priceError: "",
          isSaving: false,

          groupModal: { isEdit: false, id: null, name: "" },
          coinModal: {
            groupId: null,
            query: "",
            results: [],
            isSearching: false,
            searchError: "",
          },
          confirmDeleteModal: { groupId: null },

          async init() {
            useDirectApi = this.useDirectApi;
            await this.loadData();
            setInterval(() => this.refreshPrices(), 30 * 1000);
          },

          async loadData() {
            this.isLoading = true;
            this.loadError = "";
            try {
              this.groups = await groupApi.getAll();
            } catch (e) {
              this.loadError = e?.message || "加载失败，请稍后重试";
              this.isLoading = false;
              return;
            }
            try {
              const ids = [...new Set(this.groups.flatMap((g) => g.coins))];
              if (ids.length) {
                const data = await coingeckoApi.getMarkets(ids);
                this.prices = Object.fromEntries(data.map((c) => [c.id, c]));
                this.lastUpdated = data[0]?.last_updated
                  ? new Date(data[0].last_updated)
                  : new Date();
              }
              this.priceError = "";
            } catch (e) {
              this.priceError = e?.message || "价格加载失败";
            } finally {
              this.isLoading = false;
            }
          },

          async refreshPrices() {
            const ids = [...new Set(this.groups.flatMap((g) => g.coins))];
            if (!ids.length) return;
            try {
              const oldPrices = this.prices;
              const data = await coingeckoApi.getMarkets(ids);
              const newPrices = Object.fromEntries(data.map((c) => [c.id, c]));

              const flashes = {};
              for (const id of Object.keys(newPrices)) {
                const oldRate = oldPrices[id]?.current_price;
                const newRate = newPrices[id]?.current_price;
                if (oldRate != null && newRate != null && oldRate !== newRate) {
                  flashes[id] = newRate > oldRate ? "up" : "down";
                }
              }

              this.prices = newPrices;
              this.lastUpdated = data[0]?.last_updated
                ? new Date(data[0].last_updated)
                : new Date();
              this.priceError = "";

              if (Object.keys(flashes).length > 0) {
                this.priceFlash = flashes;
                setTimeout(() => {
                  this.priceFlash = {};
                }, 2000);
              }
            } catch (e) {
              this.priceError = e?.message || "价格更新失败";
            }
          },

          async saveGroups(groups = this.groups) {
            this.isSaving = true;
            let success = false;
            try {
              await groupApi.update(groups);
              success = true;
            } catch (e) {
              toast("保存失败，请重试", "error");
            } finally {
              this.isSaving = false;
            }
            return success;
          },

          // --- Mode ---

          toggleEditMode() {
            this.isEditMode = !this.isEditMode;
          },

          toggleApiMode() {
            this.useDirectApi = !this.useDirectApi;
            useDirectApi = this.useDirectApi;
            localStorage.setItem("cgDirectApi", String(this.useDirectApi));
            this.refreshPrices();
          },

          // --- Group actions ---

          openNewGroup() {
            this.groupModal = { isEdit: false, id: null, name: "" };
            this.$refs.groupModal.showModal();
          },

          openEditGroup(group) {
            this.groupModal = { isEdit: true, id: group.id, name: group.name };
            this.$refs.groupModal.showModal();
          },

          async confirmGroup() {
            const name = this.groupModal.name.trim();
            if (!name) return;
            let newGroups;
            if (this.groupModal.isEdit) {
              newGroups = this.groups.map((g) =>
                g.id === this.groupModal.id ? { ...g, name } : g,
              );
            } else {
              newGroups = [
                ...this.groups,
                { id: crypto.randomUUID(), name, coins: [] },
              ];
            }
            if (await this.saveGroups(newGroups)) {
              this.groups = newGroups;
              this.$refs.groupModal.close();
            }
          },

          openDeleteGroup(id) {
            this.confirmDeleteModal = { groupId: id };
            this.$refs.confirmModal.showModal();
          },

          async confirmDelete() {
            if (!this.confirmDeleteModal.groupId) return;
            this.groups = this.groups.filter(
              (g) => g.id !== this.confirmDeleteModal.groupId,
            );
            this.$refs.confirmModal.close();
            await this.saveGroups();
          },

          // --- Coin actions ---

          openAddCoin(groupId) {
            this.coinModal = {
              groupId,
              query: "",
              results: [],
              isSearching: false,
              searchError: "",
            };
            this.$refs.coinModal.showModal();
          },

          async searchCoins() {
            const q = this.coinModal.query.trim();
            if (!q) return;
            this.coinModal.isSearching = true;
            this.coinModal.searchError = "";
            this.coinModal.results = [];
            try {
              this.coinModal.results = await coingeckoApi.search(q);
            } catch (e) {
              this.coinModal.searchError = e?.message || "搜索失败";
            } finally {
              this.coinModal.isSearching = false;
            }
          },

          async selectCoin(coinId) {
            const g = this.groups.find((g) => g.id === this.coinModal.groupId);
            if (!g) return;
            if (g.coins.includes(coinId)) {
              toast("该代币已在看板中", "warning");
              return;
            }
            g.coins.push(coinId);
            this.$refs.coinModal.close();
            await this.saveGroups();
            await this.refreshPrices();
          },

          async removeCoin(groupId, symbol) {
            const g = this.groups.find((g) => g.id === groupId);
            if (!g) return;
            g.coins = g.coins.filter((c) => c !== symbol);
            await this.saveGroups();
          },

          // --- Formatting ---

          formatPrice(price) {
            if (price >= 1) {
              return (
                "$" +
                price.toLocaleString("en-US", { maximumFractionDigits: 2 })
              );
            }
            return "$" + price.toPrecision(4);
          },

          formatDelta(pct) {
            if (pct == null) return "—";
            return (pct >= 0 ? "+" : "") + pct.toFixed(2) + "%";
          },

          deltaClass(pct) {
            if (pct == null) return "text-base-content/40";
            return pct >= 0 ? "text-success" : "text-error";
          },

          formatAthDd(p) {
            if (!p?.current_price || !p?.ath) return "—";
            const dd = (p.current_price / p.ath - 1) * 100;
            return dd.toFixed(1) + "%";
          },

          athDdClass(p) {
            if (!p?.current_price || !p?.ath) return "text-base-content/40";
            return p.current_price >= p.ath ? "text-success" : "text-error/70";
          },

          formatMarketCap(cap) {
            if (!cap) return "—";
            if (cap >= 1e12) return (cap / 1e12).toFixed(2) + "T";
            if (cap >= 1e9) return (cap / 1e9).toFixed(2) + "B";
            if (cap >= 1e6) return (cap / 1e6).toFixed(2) + "M";
            return cap.toLocaleString("en-US");
          },

          get lastUpdatedText() {
            if (!this.lastUpdated) return "";
            return "更新于 " + dayjs(this.lastUpdated).format("HH:mm:ss");
          },
        }));
      });
    </script>
  </body>
</html>
